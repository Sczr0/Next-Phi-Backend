{#
  BN 模板：Neo（硬阴影 + 粗描边 + 高对比 + 几何块）
  日期：2025-12-17
  执行者：Codex

  参考：
  - `resources/templates/image/bn/card.svg`（硬阴影 + 粗描边卡片视觉）
  - `resources/templates/image/bn/default.svg.jinja`（数据契约与背景/AP 渐变/blur 逻辑）

  设计约束：
  - 不使用 CSS 变量（resvg 对 var() 支持不稳定）
  - 兼容 Theme::White/Theme::Black（通过 colors.text 推断）
#}

<svg xmlns="http://www.w3.org/2000/svg"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     width="{{ page.width }}" height="{{ page.height }}"
     viewBox="0 0 {{ page.width }} {{ page.height }}">

  {% set is_white = colors.text == "#000000" %}
  {% if is_white %}
    {% set ink = "#0A0A0A" %}
    {% set paper = "#FFFFFF" %}
    {% set dot_opacity = "0.08" %}
    {% set ap_stroke = "url(#ap-gradient-white)" %}
  {% else %}
    {% set ink = "#FFFFFF" %}
    {% set paper = "#141826" %}
    {% set dot_opacity = "0.06" %}
    {% set ap_stroke = "url(#ap-gradient)" %}
  {% endif %}

  {% set shadow = "#000000" %}
  {% set accent_a = "#FF4D8D" %}
  {% set accent_b = "#00D4FF" %}
  {% set accent_c = "#FFD166" %}
  {% set accent_ink = "#0A0A0A" %}

  {% set stroke_thick = 3 %}
  {% set stroke_medium = 2 %}
  {% set shadow_dx = 8 %}
  {% set shadow_dy = 8 %}

  <defs>
    <linearGradient id="bg-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="{{ colors.bg_grad_0 }}" />
      <stop offset="100%" stop-color="{{ colors.bg_grad_1 }}" />
    </linearGradient>

    <!-- AP 渐变（与 default.svg.jinja 对齐） -->
    <linearGradient id="ap-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#FFDA63" />
      <stop offset="100%" stop-color="#D1913C" />
    </linearGradient>
    <linearGradient id="ap-gradient-white" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#D4A017" />
      <stop offset="100%" stop-color="#B8860B" />
    </linearGradient>

    <filter id="bg-blur">
      <feGaussianBlur stdDeviation="10" />
    </filter>

    <style>
      .text { font-family: '{{ fonts.main }}', 'Impact', 'Arial Black', sans-serif; fill: {{ ink }}; }
      .text-mono { font-family: 'Courier New', monospace; font-weight: 700; fill: {{ ink }}; }

      .text-muted { opacity: 0.82; }

      .text-title { font-size: 40px; font-weight: 900; letter-spacing: -1px; }
      .text-label { font-size: 12px; font-weight: 800; letter-spacing: 1px; }
      .text-value { font-size: 18px; font-weight: 900; }

      .text-song { font-size: 20px; font-weight: 900; }
      .text-score { font-size: 32px; font-weight: 900; letter-spacing: -1px; }
      .text-meta { font-size: 14px; }
      .text-rank { font-size: 14px; font-weight: 800; text-anchor: end; }

      .stroke-thick { stroke: {{ ink }}; stroke-width: {{ stroke_thick }}px; }
      .stroke-medium { stroke: {{ ink }}; stroke-width: {{ stroke_medium }}px; }
    </style>

    <!-- 背景波点纹理（根据主题自动切换黑/白点） -->
    <pattern id="dot-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
      <circle cx="2" cy="2" r="2" fill="{{ ink }}" fill-opacity="{{ dot_opacity }}"/>
    </pattern>
  </defs>

  <!-- ==================== 背景层 ==================== -->
  {% if background.href_xml %}
    <image href="{{ background.href_xml }}" x="0" y="0" width="100%" height="100%"
           preserveAspectRatio="xMidYMid slice" filter="url(#bg-blur)" />
    <rect width="100%" height="100%" fill="{{ background.overlay_rgba }}" />
  {% else %}
    <rect width="100%" height="100%" fill="url(#bg-gradient)" />
  {% endif %}
  <rect width="100%" height="100%" fill="url(#dot-pattern)" />

  <!-- ==================== Header 区域 ==================== -->
  <!-- 玩家名称贴纸（左上） -->
  <g transform="translate(40, 40)">
    <rect x="{{ shadow_dx }}" y="{{ shadow_dy }}" width="520" height="82" fill="{{ shadow }}" />
    <rect x="0" y="0" width="520" height="82" fill="{{ accent_a }}" stroke="{{ ink }}" stroke-width="{{ stroke_thick }}" />
    <text x="18" y="56" class="text text-title" fill="#FFFFFF">{{ header.player_title_xml }}</text>
  </g>

  <!-- 统计信息贴纸（右上） -->
  <g transform="translate({{ page.width - 40 - 560 }}, 40)">
    <!-- 统计贴纸 -->
    <g transform="translate(0, 0)">
      <rect x="{{ shadow_dx }}" y="{{ shadow_dy }}" width="560" height="82" fill="{{ shadow }}" />
      <rect x="0" y="0" width="560" height="82" fill="{{ accent_b }}" stroke="{{ ink }}" stroke-width="{{ stroke_thick }}" />
      <text x="18" y="26" class="text-mono text-label" fill="{{ accent_ink }}">STATS</text>
      <text x="18" y="52" class="text text-value" fill="{{ accent_ink }}">{{ header.ap_text_xml }}</text>
      <text x="18" y="74" class="text text-value" fill="{{ accent_ink }}">{{ header.bn_text_xml }}</text>
    </g>

    <!-- 右侧行信息（Data/Challenge/Time），最多 3 行 -->
    <g transform="translate(0, 100)">
      <rect x="{{ shadow_dx }}" y="{{ shadow_dy }}" width="560" height="70" fill="{{ shadow }}" />
      <rect x="0" y="0" width="560" height="70" fill="{{ accent_c }}" stroke="{{ ink }}" stroke-width="{{ stroke_thick }}" />
      <g transform="translate(18, 22)">
        {% for line in header.right_lines %}
          {% if loop.index0 < 3 %}
            <text x="0" y="{{ 16 + loop.index0 * 20 }}" class="text-mono" fill="{{ accent_ink }}">{{ line.inner_xml }}</text>
          {% endif %}
        {% endfor %}
      </g>
    </g>
  </g>

  <!-- 分割线（粗线） -->
  <line x1="40" y1="{{ layout.header_height }}" x2="{{ page.width - 40 }}" y2="{{ layout.header_height }}"
        stroke="{{ ink }}" stroke-width="{{ stroke_thick }}" />

  <!-- ==================== AP Cards（Top 3） ==================== -->
  {% if ap.cards | length > 0 %}
  <g id="ap-section" transform="translate(0, {{ ap.section_y }})">
    {% for c in ap.cards %}
      <g transform="translate({{ c.x }}, {{ c.y }})">
        <!-- 1) 硬阴影 -->
        <rect x="{{ shadow_dx }}" y="{{ shadow_dy }}" width="{{ c.w }}" height="{{ c.h }}" rx="{{ c.radius }}" ry="{{ c.radius }}" fill="{{ shadow }}" />

        <!-- 2) 卡片主体 + AP 高亮内框 -->
        <rect width="{{ c.w }}" height="{{ c.h }}" rx="{{ c.radius }}" ry="{{ c.radius }}" fill="{{ paper }}"
              stroke="{{ ink }}" stroke-width="{{ stroke_thick }}" />
        <rect x="1.5" y="1.5" width="{{ c.w - 3 }}" height="{{ c.h - 3 }}" rx="{{ c.radius }}" ry="{{ c.radius }}"
              fill="none" stroke="{{ ap_stroke }}" stroke-width="{{ stroke_medium }}" />

        <!-- 3) 曲绘（按后端给定 cover.x/y 放置） -->
        <defs>
          <clipPath id="{{ c.clip_id }}">
            <rect x="{{ c.cover.x }}" y="{{ c.cover.y }}" width="{{ c.cover.w }}" height="{{ c.cover.h }}" rx="0" ry="0" />
          </clipPath>
        </defs>
        {% if c.cover.href_xml %}
          <image href="{{ c.cover.href_xml }}" x="{{ c.cover.x }}" y="{{ c.cover.y }}" width="{{ c.cover.w }}" height="{{ c.cover.h }}"
                 preserveAspectRatio="xMidYMid slice" clip-path="url(#{{ c.clip_id }})" />
        {% endif %}
        <rect x="{{ c.cover.x }}" y="{{ c.cover.y }}" width="{{ c.cover.w }}" height="{{ c.cover.h }}"
              fill="none" stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />

        <!-- 4) 文本 -->
        <text x="{{ c.text.song_x }}" y="{{ c.text.song_y - 5 }}" class="text text-song">{{ c.text.song_name_xml }}</text>
        <text x="{{ c.text.score_x }}" y="{{ c.text.score_y + 5 }}" class="text text-score">{{ c.text.score_text }}</text>

        <!-- 分隔线（Score / Meta） -->
        <line x1="{{ c.text.acc_x }}" y1="{{ c.text.acc_y - 10 }}" x2="{{ c.w - 12 }}" y2="{{ c.text.acc_y - 10 }}"
              stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />

        <text x="{{ c.text.acc_x }}" y="{{ c.text.acc_y }}" class="text-mono text-meta text-muted">{{ c.text.acc_text_xml }}</text>
        <text x="{{ c.text.level_x }}" y="{{ c.text.level_y }}" class="text-mono text-meta text-muted">{{ c.text.level_text_xml }}</text>
        <text x="{{ c.text.rank_x }}" y="{{ c.text.rank_y }}" class="text-mono text-rank">{{ c.text.rank_text }}</text>

        <!-- 5) 徽章（FC/AP & Diff） -->
        <rect x="{{ c.badge.diff.x }}" y="{{ c.badge.diff.y }}" width="{{ c.badge.diff.w }}" height="{{ c.badge.diff.h }}"
              rx="{{ c.badge.diff.r }}" ry="{{ c.badge.diff.r }}"
              fill="{{ c.badge.diff.fill }}" stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />
        <text x="{{ c.badge.diff.tx }}" y="{{ c.badge.diff.ty }}" text-anchor="middle" class="text"
              fill="#FFFFFF" font-size="12" font-weight="900">{{ c.badge.diff.text }}</text>

        {% if c.badge.fc_ap %}
          <rect x="{{ c.badge.fc_ap.x }}" y="{{ c.badge.fc_ap.y }}" width="{{ c.badge.fc_ap.w }}" height="{{ c.badge.fc_ap.h }}"
                rx="{{ c.badge.fc_ap.r }}" ry="{{ c.badge.fc_ap.r }}"
                fill="{{ c.badge.fc_ap.fill }}" stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />
          <text x="{{ c.badge.fc_ap.tx }}" y="{{ c.badge.fc_ap.ty }}" text-anchor="middle" class="text"
                fill="{{ c.badge.fc_ap.text_fill }}" font-size="12" font-weight="900">{{ c.badge.fc_ap.text }}</text>
        {% endif %}
      </g>
    {% endfor %}
  </g>
  {% endif %}

  <!-- ==================== Main Cards ==================== -->
  <g id="main-cards">
  {% for c in cards %}
    <g transform="translate({{ c.x }}, {{ c.y }})">
      <!-- 1) 硬阴影 -->
      <rect x="{{ shadow_dx }}" y="{{ shadow_dy }}" width="{{ c.w }}" height="{{ c.h }}" rx="{{ c.radius }}" ry="{{ c.radius }}" fill="{{ shadow }}" />

      <!-- 2) 卡片主体 + FC 高亮内框 -->
      <rect width="{{ c.w }}" height="{{ c.h }}" rx="{{ c.radius }}" ry="{{ c.radius }}" fill="{{ paper }}"
            stroke="{{ ink }}" stroke-width="{{ stroke_thick }}" />
      {% if c.class_extra == "card-fc" %}
        <rect x="1.5" y="1.5" width="{{ c.w - 3 }}" height="{{ c.h - 3 }}" rx="{{ c.radius }}" ry="{{ c.radius }}"
              fill="none" stroke="{{ colors.fc_stroke }}" stroke-width="{{ stroke_medium }}" />
      {% endif %}

      <!-- 3) 曲绘（按 cover.x/y） -->
      <defs>
        <clipPath id="{{ c.clip_id }}">
          <rect x="{{ c.cover.x }}" y="{{ c.cover.y }}" width="{{ c.cover.w }}" height="{{ c.cover.h }}" rx="0" ry="0" />
        </clipPath>
      </defs>
      {% if c.cover.href_xml %}
        <image href="{{ c.cover.href_xml }}" x="{{ c.cover.x }}" y="{{ c.cover.y }}" width="{{ c.cover.w }}" height="{{ c.cover.h }}"
               preserveAspectRatio="xMidYMid slice" clip-path="url(#{{ c.clip_id }})" />
      {% endif %}
      <rect x="{{ c.cover.x }}" y="{{ c.cover.y }}" width="{{ c.cover.w }}" height="{{ c.cover.h }}"
            fill="none" stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />

      <!-- 4) 文本 -->
      <text x="{{ c.text.song_x }}" y="{{ c.text.song_y - 5 }}" class="text text-song">{{ c.text.song_name_xml }}</text>
      <text x="{{ c.text.score_x }}" y="{{ c.text.score_y + 5 }}" class="text text-score">{{ c.text.score_text }}</text>

      <line x1="{{ c.text.acc_x }}" y1="{{ c.text.acc_y - 10 }}" x2="{{ c.w - 12 }}" y2="{{ c.text.acc_y - 10 }}"
            stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />

      <text x="{{ c.text.acc_x }}" y="{{ c.text.acc_y }}" class="text-mono text-meta text-muted">{{ c.text.acc_text_xml }}</text>
      <text x="{{ c.text.level_x }}" y="{{ c.text.level_y }}" class="text-mono text-meta text-muted">{{ c.text.level_text_xml }}</text>
      <text x="{{ c.text.rank_x }}" y="{{ c.text.rank_y }}" class="text-mono text-rank">{{ c.text.rank_text }}</text>

      <!-- 5) 徽章 -->
      <rect x="{{ c.badge.diff.x }}" y="{{ c.badge.diff.y }}" width="{{ c.badge.diff.w }}" height="{{ c.badge.diff.h }}"
            rx="{{ c.badge.diff.r }}" ry="{{ c.badge.diff.r }}"
            fill="{{ c.badge.diff.fill }}" stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />
      <text x="{{ c.badge.diff.tx }}" y="{{ c.badge.diff.ty }}" text-anchor="middle" class="text"
            fill="#FFFFFF" font-size="12" font-weight="900">{{ c.badge.diff.text }}</text>

      {% if c.badge.fc_ap %}
        <rect x="{{ c.badge.fc_ap.x }}" y="{{ c.badge.fc_ap.y }}" width="{{ c.badge.fc_ap.w }}" height="{{ c.badge.fc_ap.h }}"
              rx="{{ c.badge.fc_ap.r }}" ry="{{ c.badge.fc_ap.r }}"
              fill="{{ c.badge.fc_ap.fill }}" stroke="{{ ink }}" stroke-width="{{ stroke_medium }}" />
        <text x="{{ c.badge.fc_ap.tx }}" y="{{ c.badge.fc_ap.ty }}" text-anchor="middle" class="text"
              fill="{{ c.badge.fc_ap.text_fill }}" font-size="12" font-weight="900">{{ c.badge.fc_ap.text }}</text>
      {% endif %}
    </g>
  {% endfor %}
  </g>

  <!-- ==================== Footer ==================== -->
  {% set footer_rect_y = page.height - layout.footer_height %}
  <rect x="0" y="{{ footer_rect_y }}" width="100%" height="{{ layout.footer_height }}" fill="#000000" />
  <text x="{{ layout.footer_padding }}" y="{{ footer.y }}" class="text-mono" fill="#FFFFFF" font-size="16">{{ footer.generated_text_xml }}</text>
  {% if footer.custom_text_xml %}
    <text x="{{ page.width - layout.footer_padding }}" y="{{ footer.y }}" class="text-mono" fill="{{ accent_c }}" text-anchor="end" font-size="16">{{ footer.custom_text_xml }}</text>
  {% endif %}

</svg>
