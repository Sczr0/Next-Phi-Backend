{"openapi":"3.1.0","info":{"title":"Phi Backend API","description":"Phigros backend service (Axum)","license":{"name":""},"version":"0.1.0"},"paths":{"/auth/qrcode":{"get":{"tags":["Auth"],"operationId":"get_qrcode","responses":{"200":{"description":"生成二维码成功","content":{"application/json":{"schema":{"$ref":"#/components/schemas/QrCodeCreateResponse"}}}},"500":{"description":"服务器内部错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}}}}},"/auth/qrcode/{qr_id}/status":{"get":{"tags":["Auth"],"operationId":"get_qrcode_status","parameters":[{"name":"qr_id","in":"path","description":"二维码ID","required":true,"schema":{"type":"string"}}],"responses":{"200":{"description":"状态返回","content":{"application/json":{"schema":{"$ref":"#/components/schemas/QrCodeStatusResponse"}}}},"404":{"description":"二维码不存在或已过期"},"500":{"description":"服务器内部错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}}}}},"/image/bn":{"post":{"tags":["Image"],"operationId":"render_bn","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/RenderBnRequest"}}},"required":true},"responses":{"200":{"description":"PNG bytes of BN image"},"400":{"description":"Bad request","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}},"500":{"description":"Renderer error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}}}}},"/image/bn/user":{"post":{"tags":["Image"],"operationId":"render_bn_user","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/RenderUserBnRequest"}}},"required":true},"responses":{"200":{"description":"PNG bytes of user BN image"},"400":{"description":"Bad request","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}},"500":{"description":"Renderer error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}}}}},"/image/song":{"post":{"tags":["Image"],"operationId":"render_song","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/RenderSongRequest"}}},"required":true},"responses":{"200":{"description":"PNG bytes of song image"},"400":{"description":"Bad request","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}},"500":{"description":"Renderer error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}}}}},"/save":{"post":{"tags":["Save"],"operationId":"get_save_data","parameters":[{"name":"calculate_rks","in":"query","description":"是否计算玩家RKS（true=计算，默认不计算）","required":false,"schema":{"type":"boolean"}}],"requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/UnifiedSaveRequest"}}},"required":true},"responses":{"200":{"description":"成功解析存档并计算RKS","content":{"application/json":{"schema":{"$ref":"#/components/schemas/SaveAndRksResponseDoc"}}}},"400":{"description":"请求参数错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}},"500":{"description":"服务器内部错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}}}}},"/songs/search":{"get":{"tags":["Song"],"operationId":"search_songs","parameters":[{"name":"q","in":"query","description":"查询字符串","required":true,"schema":{"type":"string"}},{"name":"unique","in":"query","description":"是否强制唯一匹配（可选）","required":true,"schema":{"type":"boolean"}}],"responses":{"200":{"description":"查询成功（unique=true 时返回单个对象，否则为列表）","content":{"application/json":{"schema":{"$ref":"#/components/schemas/SongSearchResult"}}}},"400":{"description":"请求参数错误","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}},"404":{"description":"未找到匹配项","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}},"409":{"description":"结果不唯一（提供候选）","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AppError"}}}}}}},"/stats/daily":{"get":{"tags":["Stats"],"operationId":"get_daily_stats","parameters":[{"name":"start","in":"query","description":"开始日期 YYYY-MM-DD","required":true,"schema":{"type":"string"}},{"name":"end","in":"query","description":"结束日期 YYYY-MM-DD","required":true,"schema":{"type":"string"}},{"name":"feature","in":"query","description":"可选功能名","required":false,"schema":{"type":"string"}}],"responses":{"200":{"description":"","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/DailyAggRow"}}}}}}}}},"components":{"schemas":{"AppError":{"oneOf":[{"type":"object","description":"授权未完成（轮询等待用户确认）","required":["AuthPending"],"properties":{"AuthPending":{"type":"string","description":"授权未完成（轮询等待用户确认）"}}},{"type":"object","description":"网络请求错误","required":["Network"],"properties":{"Network":{"type":"string","description":"网络请求错误"}}},{"type":"object","description":"JSON 解析错误","required":["Json"],"properties":{"Json":{"type":"string","description":"JSON 解析错误"}}},{"type":"object","description":"认证失败 / 业务错误","required":["Auth"],"properties":{"Auth":{"type":"string","description":"认证失败 / 业务错误"}}},{"type":"object","description":"保存处理错误","required":["SaveHandlerError"],"properties":{"SaveHandlerError":{"type":"string","description":"保存处理错误"}}},{"type":"object","description":"图像渲染错误","required":["ImageRendererError"],"properties":{"ImageRendererError":{"type":"string","description":"图像渲染错误"}}},{"type":"object","description":"内部服务器错误","required":["Internal"],"properties":{"Internal":{"type":"string","description":"内部服务器错误"}}},{"type":"object","description":"存档提供器错误","required":["SaveProvider"],"properties":{"SaveProvider":{"$ref":"#/components/schemas/SaveProviderError","description":"存档提供器错误"}}},{"type":"object","description":"搜索错误","required":["Search"],"properties":{"Search":{"$ref":"#/components/schemas/SearchError","description":"搜索错误"}}}],"description":"应用统一错误类型"},"ChartConstants":{"type":"object","description":"单曲各难度定数","properties":{"at":{"type":["number","null"],"format":"float"},"ez":{"type":["number","null"],"format":"float"},"hd":{"type":["number","null"],"format":"float"},"in":{"type":["number","null"],"format":"float"}}},"ChartRankingScore":{"type":"object","description":"单张谱面的 RKS 结果","required":["song_id","difficulty","rks"],"properties":{"difficulty":{"$ref":"#/components/schemas/Difficulty"},"rks":{"type":"number","format":"double"},"song_id":{"type":"string"}}},"DailyAggRow":{"type":"object","required":["date","count","err_count"],"properties":{"count":{"type":"integer","format":"int64"},"date":{"type":"string"},"err_count":{"type":"integer","format":"int64"},"feature":{"type":["string","null"]},"method":{"type":["string","null"]},"route":{"type":["string","null"]}}},"Difficulty":{"type":"string","description":"难度枚举","enum":["EZ","HD","IN","AT"]},"ExternalApiCredentials":{"type":"object","properties":{"apiToken":{"type":["string","null"]},"apiUserId":{"type":["string","null"]},"platform":{"type":["string","null"]},"platformId":{"type":["string","null"]},"sessiontoken":{"type":["string","null"]}}},"ParsedSaveDoc":{"type":"object","required":["game_record","game_progress","user","settings","game_key"],"properties":{"game_key":{},"game_progress":{},"game_record":{},"settings":{},"summaryParsed":{},"updatedAt":{"type":["string","null"],"example":"2025-09-20T04:10:44.188Z"},"user":{}}},"PlayerRksResult":{"type":"object","description":"玩家 RKS 计算结果","required":["total_rks","b30_charts"],"properties":{"b30_charts":{"type":"array","items":{"$ref":"#/components/schemas/ChartRankingScore"}},"total_rks":{"type":"number","format":"double"}}},"QrCodeCreateResponse":{"type":"object","required":["qr_id","verification_url","qrcode_base64"],"properties":{"qr_id":{"type":"string"},"qrcode_base64":{"type":"string"},"verification_url":{"type":"string"}}},"QrCodeStatusResponse":{"type":"object","required":["status"],"properties":{"message":{"type":["string","null"]},"retryAfter":{"type":["integer","null"],"format":"int64","minimum":0},"sessionToken":{"type":["string","null"]},"status":{"type":"string"}}},"RenderBnRequest":{"allOf":[{"$ref":"#/components/schemas/UnifiedSaveRequest"},{"type":"object","properties":{"embed_images":{"type":"boolean"},"n":{"type":"integer","format":"int32","minimum":0},"nickname":{"type":["string","null"],"description":"可选：用于显示的玩家昵称（若未提供且无法从服务端获取，将使用默认占位）"},"theme":{"$ref":"#/components/schemas/Theme"}}}],"description":"BN 渲染请求体"},"RenderSongRequest":{"allOf":[{"$ref":"#/components/schemas/UnifiedSaveRequest"},{"type":"object","required":["song"],"properties":{"embed_images":{"type":"boolean"},"nickname":{"type":["string","null"],"description":"可选：用于显示的玩家昵称"},"song":{"type":"string"}}}],"description":"单曲渲染请求体"},"RenderUserBnRequest":{"type":"object","description":"用户自定义 BN 渲染请求（未验证成绩）","required":["scores"],"properties":{"nickname":{"type":["string","null"],"description":"可选昵称（未提供时可从 users/me 获取）"},"scores":{"type":"array","items":{"$ref":"#/components/schemas/UserScoreItem"},"description":"成绩列表"},"theme":{"$ref":"#/components/schemas/Theme","description":"主题（默认 black）"},"unlock_password":{"type":["string","null"],"description":"解除水印的口令（匹配配置或动态口令时，显式/隐式水印均关闭）"}}},"SaveAndRksResponse":{"type":"object","required":["save","rks"],"properties":{"rks":{"$ref":"#/components/schemas/PlayerRksResult"},"save":{}}},"SaveAndRksResponseDoc":{"type":"object","required":["save","rks"],"properties":{"rks":{"$ref":"#/components/schemas/PlayerRksResult"},"save":{"$ref":"#/components/schemas/ParsedSaveDoc"}}},"SaveProviderError":{"oneOf":[{"type":"object","description":"网络请求错误","required":["Network"],"properties":{"Network":{"type":"string","description":"网络请求错误"}}},{"type":"object","description":"认证失败","required":["Auth"],"properties":{"Auth":{"type":"string","description":"认证失败"}}},{"type":"object","description":"元数据解析错误","required":["Metadata"],"properties":{"Metadata":{"type":"string","description":"元数据解析错误"}}},{"type":"object","description":"缺少必需字段","required":["MissingField"],"properties":{"MissingField":{"type":"string","description":"缺少必需字段"}}},{"type":"object","description":"解密失败","required":["Decrypt"],"properties":{"Decrypt":{"type":"string","description":"解密失败"}}},{"type":"object","description":"完整性检查失败","required":["Integrity"],"properties":{"Integrity":{"type":"string","description":"完整性检查失败"}}},{"type":"string","description":"无效的填充","enum":["InvalidPadding"]},{"type":"object","description":"ZIP 解析错误","required":["ZipError"],"properties":{"ZipError":{"type":"string","description":"ZIP 解析错误"}}},{"type":"object","description":"I/O 错误","required":["Io"],"properties":{"Io":{"type":"string","description":"I/O 错误"}}},{"type":"object","description":"JSON 解析错误","required":["Json"],"properties":{"Json":{"type":"string","description":"JSON 解析错误"}}},{"type":"object","description":"不支持的功能","required":["Unsupported"],"properties":{"Unsupported":{"type":"string","description":"不支持的功能"}}},{"type":"object","description":"无效的响应","required":["InvalidResponse"],"properties":{"InvalidResponse":{"type":"string","description":"无效的响应"}}},{"type":"string","description":"超时","enum":["Timeout"]},{"type":"string","description":"无效的头部格式","enum":["InvalidHeader"]},{"type":"string","description":"标签验证失败","enum":["TagVerification"]},{"type":"object","description":"无效的凭据","required":["InvalidCredentials"],"properties":{"InvalidCredentials":{"type":"string","description":"无效的凭据"}}}],"description":"存档提供器错误类型"},"SaveResponse":{"type":"object","description":"存档响应结构","required":["data"],"properties":{"data":{"description":"存档数据"}}},"SaveResponseDoc":{"type":"object","required":["data"],"properties":{"data":{"$ref":"#/components/schemas/ParsedSaveDoc"}}},"SearchError":{"oneOf":[{"type":"string","description":"未找到匹配项","enum":["NotFound"]},{"type":"object","description":"结果不唯一（返回所有候选项，以便提示歧义）","required":["NotUnique"],"properties":{"NotUnique":{"type":"object","description":"结果不唯一（返回所有候选项，以便提示歧义）","required":["candidates"],"properties":{"candidates":{"type":"array","items":{"$ref":"#/components/schemas/SongInfo"}}}}}}],"description":"搜索错误类型"},"SessionData":{"type":"object","required":["session_token"],"properties":{"session_token":{"type":"string"}}},"SongInfo":{"type":"object","description":"单曲信息（来源：info/info.csv）","required":["id","name","composer","illustrator","chart_constants"],"properties":{"chart_constants":{"$ref":"#/components/schemas/ChartConstants"},"composer":{"type":"string"},"id":{"type":"string"},"illustrator":{"type":"string"},"name":{"type":"string"}}},"SongSearchResult":{"oneOf":[{"$ref":"#/components/schemas/SongInfo"},{"type":"array","items":{"$ref":"#/components/schemas/SongInfo"}}],"description":"oneOf 响应：单个 SongInfo 或 Vec<SongInfo>"},"Theme":{"type":"string","description":"渲染主题","enum":["white","black"]},"UnifiedSaveRequest":{"type":"object","description":"统一的存档请求结构","properties":{"externalCredentials":{"oneOf":[{"type":"null"},{"$ref":"#/components/schemas/ExternalApiCredentials","description":"外部 API 凭证"}]},"sessionToken":{"type":["string","null"],"description":"官方 LeanCloud 会话令牌"}}},"UserScoreItem":{"type":"object","required":["song","difficulty","acc"],"properties":{"acc":{"type":"number","format":"double","description":"ACC 百分比（示例：98.50）"},"difficulty":{"type":"string","description":"难度（EZ/HD/IN/AT）"},"score":{"type":["integer","null"],"format":"int32","description":"分数（可选）","minimum":0},"song":{"type":"string","description":"歌曲 ID 或名称"}}}}},"tags":[{"name":"Save","description":"Save APIs"},{"name":"Auth","description":"Auth APIs"},{"name":"Song","description":"Song APIs"},{"name":"Image","description":"Image APIs"},{"name":"Health","description":"Health APIs"}]}