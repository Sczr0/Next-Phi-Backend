name: Build

on:
  push:
    branches: [ "master", "feat" ]

jobs:
  # 任务一：构建和创建发布产物
  build-release:
    strategy:
      matrix:
        include:
          # Windows x86_64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          # Linux x86_64 (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          # Linux x86_64 (musl 静态链接)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          # Linux aarch64 (glibc)
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          # macOS Apple Silicon
          - target: aarch64-apple-darwin
            os: macos-latest
          # macOS Intel
          - target: x86_64-apple-darwin
            os: macos-latest
    runs-on: ${{ matrix.os }}
    env:
      EXECUTABLE_NAME: phi-backend
      
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 恢复Cargo缓存
      uses: Swatinem/rust-cache@v2
      
    - name: 安装 Rust 工具链
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}
    
    # 使用预装好的 muslrust 容器进行 musl 构建，避免系统依赖问题
    - name: 使用 muslrust 容器构建 (Linux musl)
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: |
        docker run --rm -v "$PWD:/volume" -w /volume clux/muslrust:stable \
          cargo build --release --target x86_64-unknown-linux-musl
    
    # Linux aarch64 需要安装交叉编译工具和编译 OpenSSL
    - name: 安装交叉编译工具和依赖 (Linux aarch64)
      if: matrix.target == 'aarch64-unknown-linux-gnu'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        
        # 编译 OpenSSL for aarch64
        wget https://www.openssl.org/source/openssl-3.0.15.tar.gz
        tar xzf openssl-3.0.15.tar.gz
        cd openssl-3.0.15
        ./Configure linux-aarch64 shared --prefix=/opt/openssl-aarch64 --cross-compile-prefix=aarch64-linux-gnu-
        make -j$(nproc)
        sudo make install_sw install_ssldirs
        cd ..
        
        # 设置环境变量
        echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        echo "AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/opt/openssl-aarch64" >> $GITHUB_ENV
        echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
    
    - name: 编译项目
      if: matrix.target != 'x86_64-unknown-linux-musl'
      run: cargo build --release --target ${{ matrix.target }}
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: phi-backend-${{ matrix.target }}
        # 这里的多行路径写法是正确的，它会尝试上传两个路径，
        # 并优雅地忽略不存在的那个（例如在Linux上忽略.exe）
        path: |
          target/${{ matrix.target }}/release/${{ env.EXECUTABLE_NAME }}
          target/${{ matrix.target }}/release/${{ env.EXECUTABLE_NAME }}.exe